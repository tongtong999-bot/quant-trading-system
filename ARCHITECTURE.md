# 系统架构文档

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    量化交易系统架构                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   数据层    │  │   策略层    │  │   风控层    │  │   分析层    │ │
│  │ Data Layer  │  │Strategy Layer│  │ Risk Layer  │  │Analysis Layer│ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   回测引擎  │  │   工具模块  │  │   配置管理  │  │   主程序    │ │
│  │Backtest Eng │  │Utils Module │  │Config Mgmt  │  │Main Program │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 模块详细设计

### 1. 数据层 (Data Layer)

#### 1.1 数据管理器 (BinanceDataManager)
**位置**: `src/data/data_manager.py`

**功能**:
- 币安API数据获取
- 数据清洗和预处理
- 技术指标计算
- 流动性检查
- 数据存储和加载

**核心方法**:
```python
async def get_new_listings(limit: int) -> List[Dict]
async def check_liquidity(symbol: str) -> Tuple[bool, Dict]
async def fetch_historical_data(symbol: str, days: int) -> pd.DataFrame
async def fetch_funding_rates(symbol: str) -> pd.DataFrame
```

**数据流**:
```
币安API → 数据获取 → 数据清洗 → 技术指标 → 数据存储
```

### 2. 策略层 (Strategy Layer)

#### 2.1 Delta管理策略 (DeltaStrategy)
**位置**: `src/strategy/delta_strategy.py`

**功能**:
- 趋势状态判断
- 建仓决策
- 动态调仓
- 仓位管理

**核心组件**:
- `Position`: 仓位信息
- `Trade`: 交易记录
- `TrendState`: 趋势状态枚举
- `PositionType`: 仓位类型枚举

**策略流程**:
```
市场数据 → 趋势判断 → 建仓决策 → 动态调仓 → 仓位管理
```

**调仓逻辑**:
1. **上升趋势**: 分批平空单，释放现货上涨潜力
2. **下跌趋势**: 卖出现货，保留空单捕获下跌
3. **震荡趋势**: 维持中性对冲，等待机会

### 3. 风控层 (Risk Layer)

#### 3.1 风控管理器 (RiskManager)
**位置**: `src/risk/risk_manager.py`

**功能**:
- 实时风险监控
- 多层风控规则
- 成本控制
- 强制平仓

**风控规则**:
- 净敞口限制 (≤30%)
- 最大亏损限制 (≤15%)
- 时间止损 (12小时)
- 价格止损 (10%偏离)
- 保证金使用率 (≤70%)

**风险指标**:
```python
@dataclass
class RiskMetrics:
    net_exposure_ratio: float      # 净敞口比例
    max_loss_ratio: float          # 最大亏损比例
    margin_usage_ratio: float      # 保证金使用率
    time_exposure_hours: float     # 时间敞口
    price_deviation_ratio: float   # 价格偏离比例
    total_fees: float              # 总手续费
    slippage_cost: float           # 滑点成本
    funding_cost: float            # 资金费率成本
```

### 4. 回测引擎 (Backtest Engine)

#### 4.1 回测引擎 (BacktestEngine)
**位置**: `src/backtest/backtest_engine.py`

**功能**:
- 向量化回测计算
- 并行处理
- 性能统计
- 结果保存

**回测流程**:
```
历史数据 → 策略执行 → 风控检查 → 性能计算 → 结果输出
```

**并行处理**:
- 支持多币种并行回测
- 可配置工作进程数
- 超时保护机制

### 5. 分析层 (Analysis Layer)

#### 5.1 结果分析器 (ResultAnalyzer)
**位置**: `src/analysis/result_analyzer.py`

**功能**:
- 性能指标计算
- 可视化图表生成
- HTML报告生成
- 风险分析

**性能指标**:
- 总收益率、年化收益率
- 最大回撤、夏普比率
- 卡玛比率、索提诺比率
- 胜率、盈亏比
- VaR、CVaR

**可视化图表**:
- 权益曲线图
- 回撤曲线图
- 性能对比图
- 风险分析图

### 6. 工具层 (Utils Layer)

#### 6.1 工具模块 (Helpers)
**位置**: `src/utils/helpers.py`

**功能**:
- 通用工具函数
- 数据处理工具
- 数学计算函数
- 格式化工具

**核心功能**:
- 重试装饰器
- 安全除法
- 技术指标计算
- 数据标准化
- 异常值检测

## 数据流架构

### 1. 数据获取流程
```
币安API → BinanceDataManager → 数据清洗 → 技术指标 → 数据存储
```

### 2. 回测执行流程
```
历史数据 → DeltaStrategy → RiskManager → BacktestEngine → ResultAnalyzer
```

### 3. 实时交易流程 (未来扩展)
```
实时数据 → 策略判断 → 风控检查 → 交易执行 → 仓位管理
```

## 配置管理

### 配置文件结构
```yaml
data:           # 数据配置
strategy:       # 策略参数
risk_control:   # 风控参数
backtest:       # 回测配置
output:         # 输出配置
```

### 参数层次
1. **系统级参数**: 基础配置
2. **策略级参数**: 交易逻辑
3. **风控级参数**: 风险控制
4. **回测级参数**: 测试设置

## 错误处理

### 1. 异常分类
- **网络异常**: API连接失败
- **数据异常**: 数据质量问题
- **策略异常**: 策略执行错误
- **风控异常**: 风控规则触发

### 2. 错误恢复
- 自动重试机制
- 降级处理
- 日志记录
- 状态恢复

## 性能优化

### 1. 计算优化
- 向量化计算
- 并行处理
- 内存管理
- 缓存机制

### 2. 网络优化
- 连接池
- 请求合并
- 超时控制
- 重试策略

### 3. 存储优化
- 数据压缩
- 增量更新
- 索引优化
- 清理策略

## 扩展性设计

### 1. 策略扩展
- 插件化架构
- 策略接口标准化
- 参数配置化
- 回测框架通用化

### 2. 数据源扩展
- 多交易所支持
- 数据源抽象层
- 统一数据格式
- 实时数据流

### 3. 风控扩展
- 规则引擎
- 动态参数调整
- 机器学习风控
- 实时监控

## 安全考虑

### 1. 数据安全
- 敏感信息加密
- 访问控制
- 数据备份
- 审计日志

### 2. 交易安全
- 风控优先
- 权限控制
- 操作确认
- 异常处理

### 3. 系统安全
- 输入验证
- SQL注入防护
- XSS防护
- 安全配置

## 监控和运维

### 1. 系统监控
- 性能指标
- 错误率监控
- 资源使用监控
- 业务指标监控

### 2. 日志管理
- 结构化日志
- 日志级别
- 日志轮转
- 日志分析

### 3. 告警机制
- 阈值告警
- 异常告警
- 业务告警
- 通知机制

## 部署架构

### 1. 单机部署
```
主程序 → 数据管理 → 策略执行 → 结果输出
```

### 2. 分布式部署 (未来)
```
数据节点 → 计算节点 → 存储节点 → 监控节点
```

### 3. 容器化部署
```
Docker容器 → Kubernetes → 服务发现 → 负载均衡
```

## 技术栈

### 1. 核心语言
- Python 3.8+

### 2. 数据处理
- pandas: 数据处理
- numpy: 数值计算
- ta: 技术指标

### 3. 网络通信
- ccxt: 交易所API
- aiohttp: 异步HTTP
- requests: 同步HTTP

### 4. 可视化
- matplotlib: 基础图表
- seaborn: 统计图表
- plotly: 交互图表

### 5. 配置管理
- pyyaml: YAML配置
- loguru: 日志管理

## 总结

本系统采用模块化设计，各层职责清晰，便于维护和扩展。通过合理的架构设计，实现了：

1. **高内聚低耦合**: 各模块独立，接口清晰
2. **可扩展性**: 支持新策略、新数据源、新风控规则
3. **可维护性**: 代码结构清晰，文档完善
4. **高性能**: 向量化计算，并行处理
5. **高可靠性**: 完善的错误处理和风控机制

系统为量化交易提供了完整的解决方案，从数据获取到策略回测，从风险控制到结果分析，形成了完整的闭环。
